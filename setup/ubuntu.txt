# Setting up the server

## Assumptions

NGINX and Postgres are installed and running, the former on HTTPS.

Caves site is configured at /etc/nginx/sites-available/caves.conf

## Initial setup

(1) SSH to the VM.

(2) sudo su

(3) apt install npm

(4) npm install -g n

(5) n stable

(6) hash -r

(7) npm install -g yarn

(8) Add the following to /etc/nginx/sites-available/caves.conf (e.g. using vim), at the very start of the file, before "server {".

    upstream app_yourdomain {
        server 127.0.0.1:3000;
        keepalive 8;
    }
    
(9) Add the following to /etc/nginx/sites-available/caves.conf before the final bracket of "server { ... }":

    location /api {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X-NginX-Proxy true;

      proxy_pass http://127.0.0.1:3000/api;
      proxy_redirect off;
    }
    
(10) Run "nginx -t" to check the syntax of caves.conf and correct any errors.

(11) /etc/init.d/nginx restart

(12) Exit su mode

(13) You can test the setup at this point by going to https://caves.tacc.utexas.edu/api and making sure you get a "502 bad gateway" error.

(14) cd ~

(15) If you haven't done this step before, type:

    cd ~
    git clone https://github.com/ut-entomology/cavesite.git
    cd cavesite
   
Otherwise update the repo:

    cd ~/cavesite
    git pull
    
(16) From within ~/cavesite, type this in order to get the right dependency versions:

    yarn
    
(17) From within ~/cavesite:

	yarn build
	sudo ./bin/deploy

	

TODO: install node monitoring and restart
